<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Egenkontroll N√¶ringsbygg</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"/>
  <style>
    :root {
      --bg: #f4f6f9;
      --card: #fff;
      --primary: #4a90e2;
      --accent: #50e3c2;
      --text: #333;
      --shadow: rgba(0, 0, 0, 0.05);
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); }
    header { background: var(--primary); color: #fff; padding: 1rem; text-align: center; }
    .container { max-width: 800px; margin: auto; padding: 1rem; }
    .card { background: var(--card); border-radius: 10px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 12px var(--shadow); }
    .card h2 { display: flex; align-items: center; font-size: 1.1rem; margin-bottom: 0.5rem; }
    .card h2 i { margin-right: 0.5rem; color: var(--accent); }
    label { display: block; margin: 0.4rem 0; }
    input[type="checkbox"], input[type="date"], input[type="text"], input[type="file"] { margin-right: 0.75rem; }
    input[type="text"], input[type="date"], input[type="file"] {
      width: 100%; padding: 0.5rem; margin-top: 0.25rem;
      border: 1px solid #ccc; border-radius: 5px;
    }
    textarea { width: 100%; padding: 0.75rem; border: 1px solid #ccc; border-radius: 5px; resize: vertical; }
    .img-preview img { max-width: 100px; margin: 0.5rem; border-radius: 5px; }
    .buttons { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 1rem; }
    button { flex: 1; padding: 0.75rem; border: none; border-radius: 5px; background: var(--primary); color: #fff; cursor: pointer; font-weight: bold; }
    button:hover { opacity: 0.9; }
    .download-links a { margin-right: 10px; }
    @media (max-width: 600px) { .buttons { flex-direction: column; } }
  </style>
</head>
<body>
  <header><h1>Egenkontroll N√¶ringsbygg</h1></header>
  <div class="container">
    <form id="form">
      <!-- Kontrollinformasjon -->
      <div class="card">
        <h2><i class="fa-solid fa-calendar"></i> Kontrollinformasjon</h2>
        <label>Dato for kontroll:<br /><input type="date" name="kontrolldato" required /></label>
        <label>Utf√∏rt av (signatur):<br /><input type="text" name="signatur" placeholder="Navn / signatur" required /></label>
      </div>

      <!-- Seksjoner 1‚Äì7... -->
      <!-- (Same as previous: Bygg ‚Üí Universell utforming) -->

      <!-- Seksjon 7: Dokumentasjon -->
      <div class="card">
        <h2><i class="fa-solid fa-folder-open"></i> 7. Dokumentasjon og rutiner</h2>
        <label><input type="checkbox" name="dok1"> HMS-plan er oppdatert</label>
        <label><input type="checkbox" name="dok2"> FDV-dokumentasjon er tilgjengelig</label>
        <label><input type="checkbox" name="dok3"> Serviceavtaler er dokumentert</label>
        <label><input type="checkbox" name="dok4"> Kontrollrapporter er arkivert</label>
        <label><input type="checkbox" name="dok5"> Avvik registreres og f√∏lges opp</label>
        <label><input type="checkbox" name="dok6"> Rutiner for egenkontroll f√∏lges</label>
      </div>

      <!-- Notater -->
      <div class="card">
        <h2><i class="fa-solid fa-note-sticky"></i> Notater</h2>
        <textarea name="notater" rows="4" placeholder="Skriv observasjoner..."></textarea>
      </div>

      <!-- Bilder -->
      <div class="card">
        <h2><i class="fa-solid fa-image"></i> Bilder</h2>
        <input type="file" name="bilder" accept="image/*" multiple onchange="previewImages(event)" />
        <div class="img-preview"></div>
      </div>

      <!-- Knappene -->
      <div class="buttons">
        <button type="button" onclick="lagre()">üíæ Lagre</button>
        <button type="button" onclick="hent()">üîÑ Hent</button>
        <button type="button" onclick="nullstill()">üóëÔ∏è Nullstill</button>
        <button type="button" onclick="eksporterPDF()">üìÑ PDF</button>
        <button type="button" onclick="eksporterExcel()">üìä Excel</button>
      </div>
    </form>
    <div class="download-links"></div>
  </div>

  <!-- Skripter -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const n√∏kkel = 'egenkontroll-data';

    // Automatiske dato
    document.addEventListener('DOMContentLoaded', () => {
      const ctrlDato = document.querySelector('[name=kontrolldato]');
      ctrlDato.value = new Date().toISOString().split('T')[0];
    });

    function previewImages(e) {
      const container = document.querySelector('.img-preview');
      container.innerHTML = '';
      const files = Array.from(e.target.files);
      const images = files.map(f => URL.createObjectURL(f));
      images.forEach(src => {
        const img = document.createElement('img');
        img.src = src;
        container.appendChild(img);
      });
    }

    function lagre() {
      const data = {};
      const form = document.forms[0];
      [...form.elements].forEach(el => {
        if (el.name) {
          if (el.type==='file') {
            const files = el.files;
            data.bilder = [];
            Array.from(files).forEach(f => {
              const reader = new FileReader();
              reader.onload = () => {
                data.bilder.push(reader.result);
                localStorage.setItem(n√∏kkel, JSON.stringify(data));
              };
              reader.readAsDataURL(f);
            });
          } else {
            data[el.name] = el.type==='checkbox' ? el.checked : el.value;
            localStorage.setItem(n√∏kkel, JSON.stringify(data));
          }
        }
      });
      alert('‚úîÔ∏è Lagret!');
    }

    function hent() {
      const data = JSON.parse(localStorage.getItem(n√∏kkel) || '{}');
      const form = document.forms[0];
      [...form.elements].forEach(el => {
        if (data.hasOwnProperty(el.name)) {
          if (el.type==='checkbox') el.checked = data[el.name];
          else if (el.type!=='file') el.value = data[el.name];
        }
      });
      if (data.bilder) {
        const container = document.querySelector('.img-preview');
        container.innerHTML = '';
        data.bilder.forEach(src => {
          const img = document.createElement('img');
          img.src = src;
          container.appendChild(img);
        });
      }
    }

    function nullstill() {
      if (confirm('Slette all data?')) {
        localStorage.removeItem(n√∏kkel);
        document.forms[0].reset();
        document.querySelector('.img-preview').innerHTML = '';
      }
    }

    async function eksporterPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const data = JSON.parse(localStorage.getItem(n√∏kkel) || '{}');
      let y = 40;
      doc.setFontSize(16);
      doc.text('Egenkontroll n√¶ringsbygg', 40, y); y+=30;

      const seksjoner = {
        '1. Bygg': ['bygg1','bygg2','bygg3','bygg4','bygg5'],
        '2. Brann': ['brann1','brann2','brann3','brann4','brann5'],
        '3. Elektrisk': ['el1','el2','el3','el4','el5'],
        '4. VVS/Ventilasjon': ['vvs1','vvs2','vvs3','vvs4'],
        '5. Renhold': ['rh1','rh2','rh3','rh4'],
        '6. Universell utforming': ['uu1','uu2','uu3','uu4'],
        '7. Dokumentasjon & rutiner': ['dok1','dok2','dok3','dok4','dok5','dok6']
      };

      doc.setFontSize(12);
      for (const [title, keys] of Object.entries(seksjoner)) {
        doc.setFont(undefined, 'bold'); doc.text(title, 40, y); y+=20;
        doc.setFont(undefined, 'normal');
        keys.forEach(key => {
          doc.text(`‚Ä¢ ${key}: ${data[key] ? '‚úÖ' : '‚ùå'}`, 60, y); y+=18;
          if (y>750) {doc.addPage(); y=40;}
        });
        y+=10;
      }

      if (data.notater) {
        doc.setFont(undefined,'bold'); doc.text('üìù Notater',40,y); y+=20;
        doc.setFont(undefined,'normal');
        doc.text(doc.splitTextToSize(data.notater, 500), 60, y);
        y+=20;
      }

      y+=20;
      doc.setFont(undefined,'bold'); doc.text('Signatur og dato',40,y); y+=20;
      doc.setFont(undefined,'normal');
      doc.text(`üñäÔ∏è ${data.signatur}`,60,y); y+=18;
      doc.text(`üìÖ ${data.kontrolldato}`,60,y); y+=30;

      if (data.bilder) {
        for (const src of data.bilder) {
          doc.addImage(src, 'JPEG', 60, y, 100, 100);
          y+=110;
          if (y>700) {doc.addPage(); y=40;}
        }
      }

      const pdfBlob = doc.output('blob');
      const url = URL.createObjectURL(pdfBlob);
      const link = document.querySelector('.download-links');
      link.innerHTML = `<a href="${url}" download="egenkontroll.pdf">Last ned PDF</a>`;
    }

    function eksporterExcel() {
      const data = JSON.parse(localStorage.getItem(n√∏kkel) || '{}');
      const rows = [];
      const seksjoner = {
        '1. Bygg': ['bygg1','bygg2','bygg3','bygg4','bygg5'],
        '2. Brann': ['brann1','brann2','brann3','brann4','brann5'],
        '3. Elektrisk': ['el1','el2','el3','el4','el5'],
        '4. VVS/Vent': ['vvs1','vvs2','vvs3','vvs4'],
        '5. Renhold': ['rh1','rh2','rh3','rh4'],
        '6. Universell utforming': ['uu1','uu2','uu3','uu4'],
        '7. Dokumentasjon & rutiner': ['dok1','dok2','dok3','dok4','dok5','dok6']
      };

      Object.entries(seksjoner).forEach(([title, keys]) => {
        rows.push({ Seksjon: title });
        keys.forEach(k => rows.push({ Punkt: k, Status: data[k] ? 'OK' : 'Mangler' }));
        rows.push({});
      });

      rows.push({ Notater: data.notater || '' });
      rows.push({ Signatur: data.signatur || '', Dato: data.kontrolldato || '' });

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Egenkontroll');
      const wbout = XLSX.write(wb, { bookType:'xlsx', type:'array' });
      const blob = new Blob([wbout], { type: 'application/octet-stream' });
      const url = URL.createObjectURL(blob);
      const link = document.querySelector('.download-links');
      link.innerHTML += `<a href="${url}" download="egenkontroll.xlsx">Last ned Excel</a>`;
    }

    window.onload = hent;
  </script>
</body>
</html>
