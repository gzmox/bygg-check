<!DOCTYPE html>
<html lang="no">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Egenkontroll NÃ¦ringsbygg</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f6f9;
      color: #333;
      margin: 0;
    }
    header {
      background: #4a90e2;
      color: white;
      padding: 1rem;
      text-align: center;
    }
    .container {
      max-width: 800px;
      margin: auto;
      padding: 1rem;
    }
    .card {
      background: white;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    label {
      display: block;
      margin: 0.5rem 0;
    }
    input[type="text"],
    input[type="date"],
    textarea {
      width: 100%;
      padding: 0.5rem;
      margin-top: 0.25rem;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    textarea {
      resize: vertical;
    }
    .buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }
    button {
      flex: 1;
      padding: 0.75rem;
      border: none;
      border-radius: 5px;
      background: #4a90e2;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    button:hover {
      opacity: 0.9;
    }
    input[type="file"] {
      margin-top: 0.5rem;
    }
    #preview {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 1rem;
    }
    #preview img {
      max-width: 100px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    #download-links {
      margin-top: 1rem;
      display: none;
    }
    #download-links a {
      display: inline-block;
      margin-right: 10px;
      color: #4a90e2;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <header>
    <h1>Egenkontroll NÃ¦ringsbygg</h1>
  </header>
  <div class="container">
    <form id="form">
      <div class="card">
        <h2>Kontrollinformasjon</h2>
        <label>Dato for kontroll:
          <input type="date" name="kontrolldato" id="kontrolldato" />
        </label>
        <label>UtfÃ¸rt av (signatur):
          <input type="text" name="signatur" placeholder="Navn / signatur" required />
        </label>
      </div>

      <div class="card">
        <h2>ğŸ–¼ï¸ Last opp bilder</h2>
        <input type="file" id="bilder" multiple accept="image/*" />
        <div id="preview"></div>
        <label><input type="checkbox" id="inkluderPdfBilder" /> Inkluder bilder i PDF</label>
        <label><input type="checkbox" id="inkluderExcelBilder" /> Inkluder bilder i Excel (lenke)</label>
      </div>

      <!-- Sjekkliste-seksjoner -->
      <div id="seksjoner"></div>

      <div class="card">
        <h2>ğŸ“ Notater</h2>
        <textarea name="notater" rows="4" placeholder="Skriv notater eller observasjoner her..."></textarea>
      </div>

      <div class="buttons">
        <button type="button" onclick="lagre()">ğŸ’¾ Lagre</button>
        <button type="button" onclick="hent()">ğŸ”„ Hent</button>
        <button type="button" onclick="nullstill()">ğŸ—‘ï¸ Nullstill</button>
        <button type="button" onclick="eksporterPDF()">ğŸ“„ PDF</button>
        <button type="button" onclick="eksporterExcel()">ğŸ“Š Excel</button>
      </div>

      <div id="download-links">
        <p>Last ned:</p>
        <a id="pdfLink" href="#" download="egenkontroll.pdf">ğŸ“¥ PDF</a>
        <a id="excelLink" href="#" download="egenkontroll.xlsx">ğŸ“¥ Excel</a>
      </div>
    </form>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const nÃ¸kkel = 'egenkontroll-data';
    const today = '2025-07-05';
    const seksjoner = [
      ['1. Bygg', ['Fasade og yttervegger', 'Tak er tett', 'Vinduer og dÃ¸rer', 'RÃ¸mningsveier', 'Trapper og rekkverk']],
      ['2. Brann', ['Brannalarmanlegg', 'RÃ¸ykvarslere', 'Slokkeutstyr', 'Branninstruks', 'NÃ¸dlys']],
      ['3. Elektrisk', ['Sikringsskap', 'Skader pÃ¥ ledninger', 'Kontakter jordet', 'Jordfeilbryter', 'NÃ¸dbelysning']],
      ['4. VVS/Ventilasjon', ['Ingen lekkasjer', 'Vanntrykk og temperatur', 'Ventilasjon filtrert', 'KjÃ¸ling og varme']],
      ['5. Renhold', ['Avfall', 'SanitÃ¦ranlegg', 'Renholdsrutiner', 'SÃ¥pe og papir']],
      ['6. Universell utforming', ['Trinnfri inngang', 'Tilgjengelig toalett', 'Lesbare skilt', 'Tilrettelegging synshemmede']],
      ['7. Dokumentasjon og rutiner', ['HMS-plan oppdatert', 'FDV-dokumentasjon', 'Serviceavtaler', 'Kontrollrapporter', 'Avvik fÃ¸lger opp', 'Rutiner fÃ¸lges']]
    ];

    document.getElementById('kontrolldato').value = today;

    const seksjonerDiv = document.getElementById('seksjoner');
    seksjoner.forEach(([title, points], idx) => {
      const div = document.createElement('div');
      div.className = 'card';
      const id = `s${idx + 1}`;
      div.innerHTML = `<h2>${title}</h2>` + points.map((p, i) =>
        `<label><input type="checkbox" name="${id}_p${i+1}"> ${p}</label>`).join('');
      seksjonerDiv.appendChild(div);
    });

    // Bildevisning
    const bildeData = [];
    document.getElementById('bilder').addEventListener('change', e => {
      const preview = document.getElementById('preview');
      preview.innerHTML = '';
      bildeData.length = 0;
      [...e.target.files].forEach(file => {
        const reader = new FileReader();
        reader.onload = function(evt) {
          bildeData.push(evt.target.result);
          const img = document.createElement('img');
          img.src = evt.target.result;
          preview.appendChild(img);
        };
        reader.readAsDataURL(file);
      });
    });

    function lagre() {
      const form = document.getElementById('form');
      const data = {};
      [...form.elements].forEach(el => {
        if (el.name) data[el.name] = el.type === 'checkbox' ? el.checked : el.value;
      });
      localStorage.setItem(nÃ¸kkel, JSON.stringify(data));
      alert('âœ”ï¸ Lagret!');
    }

    function hent() {
      const data = JSON.parse(localStorage.getItem(nÃ¸kkel) || '{}');
      [...document.forms[0].elements].forEach(el => {
        if (data.hasOwnProperty(el.name)) {
          el.type === 'checkbox' ? el.checked = data[el.name] : el.value = data[el.name];
        }
      });
    }

    function nullstill() {
      if (confirm('Slette all lagret data?')) {
        localStorage.removeItem(nÃ¸kkel);
        document.getElementById('form').reset();
        document.getElementById('preview').innerHTML = '';
      }
    }

    async function eksporterPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: 'pt', format: 'a4' });
      const data = JSON.parse(localStorage.getItem(nÃ¸kkel) || '{}');
      let y = 40;
      doc.setFontSize(16);
      doc.text('Egenkontroll nÃ¦ringsbygg', 40, y);
      y += 30;

      seksjoner.forEach(([title, points], i) => {
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text(`${title}`, 40, y);
        y += 20;
        doc.setFont(undefined, 'normal');
        points.forEach((txt, j) => {
          const key = `s${i+1}_p${j+1}`;
          const val = data[key] ? 'âœ…' : 'âŒ';
          doc.text(`â€¢ ${txt}: ${val}`, 60, y);
          y += 18;
        });
        y += 10;
      });

      if (data.notater) {
        doc.setFont(undefined, 'bold');
        doc.text('ğŸ“ Notater:', 40, y); y += 20;
        doc.setFont(undefined, 'normal');
        const lines = doc.splitTextToSize(data.notater, 460);
        doc.text(lines, 60, y); y += lines.length * 16;
      }

      y += 30;
      doc.setFont(undefined, 'bold');
      doc.text('Signatur og dato:', 40, y); y += 20;
      doc.setFont(undefined, 'normal');
      doc.text(`ğŸ–Šï¸ ${data.signatur || ''}`, 60, y); y += 18;
      doc.text(`ğŸ“… ${data.kontrolldato || ''}`, 60, y);

      if (document.getElementById('inkluderPdfBilder').checked) {
        y += 30;
        doc.setFont(undefined, 'bold');
        doc.text('ğŸ–¼ï¸ Vedlagte bilder:', 40, y); y += 20;
        for (let i = 0; i < bildeData.length; i++) {
          if (y > 700) { doc.addPage(); y = 40; }
          doc.addImage(bildeData[i], 'JPEG', 60, y, 100, 75);
          y += 85;
        }
      }

      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      document.getElementById('pdfLink').href = url;
      document.getElementById('download-links').style.display = 'block';
    }

    function eksporterExcel() {
      const data = JSON.parse(localStorage.getItem(nÃ¸kkel) || '{}');
      const rows = [];

      seksjoner.forEach(([title, points], i) => {
        rows.push({ Seksjon: title });
        points.forEach((txt, j) => {
          const key = `s${i+1}_p${j+1}`;
          rows.push({ Punkt: txt, Status: data[key] ? 'OK' : 'Mangler' });
        });
        rows.push({});
      });

      rows.push({ Notater: data.notater || '' });
      rows.push({ Signatur: data.signatur || '', Dato: data.kontrolldato || '' });

      if (document.getElementById('inkluderExcelBilder').checked) {
        bildeData.forEach((base64, i) => {
          rows.push({ Bilde: `Vedlagt bilde ${i + 1}`, Base64: base64.substring(0, 50) + '...' });
        });
      }

      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Egenkontroll');
      const wbout = XLSX.write(wb, { bookType: 'xlsx', type: 'blob' });

      const url = URL.createObjectURL(wbout);
      document.getElementById('excelLink').href = url;
      document.getElementById('download-links').style.display = 'block';
    }

    window.onload = hent;
  </script>
</body>
</html>
